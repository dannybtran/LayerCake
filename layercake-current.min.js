(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.extend=arguments.callee;return c}})();var LayerCake={next_view_id:0,bake:function(a){if(!this.root){switch(typeof(a)){case"object":var b=a;break;case"string":var b=document.getElementById(a);break}this.root=new RootView(b)}return this.root},auto_increment:function(){return this.next_view_id++}};var Point=Class.extend({init:function(a,b){this.x=a;this.y=b},equals:function(a){if(this.x==a.x&&this.y==a.y){return true}return false}});var View=Class.extend({init:function(a,b){this.id=LayerCake.auto_increment();this.origin=new Point(a,b);this.bounds={width:0,height:0};this.canvas=null;this.ctx=null;this.rootview=null;this.superview=null;this.subviews=[];this.visible=true;this.clickable=false;this.draggable=false;this.isDragging=false;this.isMouseDown=false;this._dragOrigin;this._dragPoint;this._mouseDownOrigin;this._mousedOver=false;this._mousedOut=true},_relate:function(a,c){a.rootview=(c instanceof RootView)?c:c.rootview;a.superview=c;a.canvas=c.canvas;a.ctx=c.ctx;for(var b in a.subviews){a.subviews[b]._relate(a.subviews[b],a)}return a},_drawSubviews:function(){for(var a in this.subviews){if(this.subviews[a].visible){this.subviews[a].draw()}}},_click:function(b){if(!this.visible){return false}for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._click(b)){return true}}if(!this.pointInView(new Point(b.clientX,b.clientY))){return false}if(this._clickableMouseHasNotMoved()){this._mouseDownOrigin=null;this._clickHandler(b)}return true},_clickableMouseHasNotMoved:function(){if(!this._mouseDownOrigin){return false}return this.clickable&&this._mouseDownOrigin.equals(this.convertPointToWindow(this.origin))},_clickHandler:function(a){},_mousedown:function(b){if(!this.visible){return false}for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._mousedown(b)){return true}}if(!this.pointInView(new Point(b.clientX,b.clientY))){return false}this._mouseDownOrigin=this.convertPointToWindow(this.origin);this._mousedownHandler(b);if(!this.draggable||this.isDragging){return false}this._startDrag(b);return true},_mousedownHandler:function(a){},_mouseup:function(b){if(!this.visible){return false}for(var a in this.subviews){if(this.subviews[a]._mouseup(b)){return false}}this._mouseupHandler(b);if(this.isDragging){this._stopDrag(b)}return false},_mouseupHandler:function(a){},_mousemove:function(b){if(!this.visible){return false}if(this.isDragging){var c=new Point(b.clientX-this._dragPoint.x,b.clientY-this._dragPoint.y);this.origin=new Point(this._dragOrigin.x+c.x,this._dragOrigin.y+c.y);this.rootview.draw();return true}for(var a in this.subviews){if(this.subviews[a]._mousemove(b)){return false}}if(this.pointInView(new Point(b.clientX,b.clientY))){this._mousemoveHandler(b);if(!this._mousedOver){this._mouseover(b)}}else{if(!this._mousedOut){this._mouseout(b)}}return false},_mousemoveHandler:function(a){},_mouseover:function(a){this._mousedOver=true;this._mousedOut=false;this._mouseoverHandler(a)},_mouseoverHandler:function(a){},_mouseout:function(a){this._mousedOver=false;this._mousedOut=true;this._mouseoutHandler(a)},_mouseoutHandler:function(a){},_startDrag:function(a){this._dragOrigin=this.origin;this._dragPoint=new Point(a.clientX,a.clientY);this.isDragging=true},_stopDrag:function(a){this.isDragging=false},addSubview:function(a){a=this._relate(a,this);this.subviews.push(a)},removeSubview:function(a){for(var b=0;b<this.subviews.length;b++){if(a.id==this.subviews[b].id){this.subviews.splice(b,1);return true}}return false},draw:function(){this._drawSubviews()},click:function(a){this.clickable=true;this._clickHandler=a},mousedown:function(a){this._mousedownHandler=a},mouseup:function(a){this._mouseupHandler=a},mousemove:function(a){this._mousemoveHandler=a},mouseover:function(a){this._mouseoverHandler=a},mouseout:function(a){this._mouseoutHandler=a},pointInView:function(a){return false},convertPointToView:function(e,c){var d=this;var b=e.x,a=e.y;while(d.superview&&c!=d){d=d.superview;b+=d.origin.x;a+=d.origin.y}return new Point(b,a)},convertPointToWindow:function(b){var a=this.convertPointToView(b,this.rootview);return new Point(a.x+this.canvas.offsetLeft-window.scrollX,a.y+this.canvas.offsetTop-window.scrollY)},map:function(b){for(var a in this.subviews){this.subviews[a].map(b)}this.tempFoo=b;this.tempFoo();this.tempFoo=null}});var RootView=View.extend({init:function(b){this._super(0,0);this.canvas=b;this.ctx=b.getContext("2d");var a=this;this.canvas.addEventListener("click",(function(c){return a.click(c)}),true);this.canvas.addEventListener("mousedown",(function(c){return a.mousedown(c)}),true);this.canvas.addEventListener("mouseup",(function(c){return a.mouseup(c)}),true);this.canvas.addEventListener("mousemove",(function(c){return a.mousemove(c)}),true)},draw:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);if(!this.visible){return}for(var a in this.subviews){if(this.subviews[a].visible){this.subviews[a].draw()}}},click:function(b){for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._click(b)){return}}},mousedown:function(b){for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._mousedown(b)){return}}},mouseup:function(b){for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._mouseup(b)){return}}},mousemove:function(b){for(var a=this.subviews.length-1;a>=0;a--){if(this.subviews[a]._mousemove(b)){return}}}});var RectView=View.extend({init:function(b,d,c,a){this._super(b,d);this.bounds={width:c,height:a};this.strokeStyle="#F00";this.lineWidth=5;this.fillStyle="#000"},draw:function(){this.ctx.fillStyle=this.fillStyle;this.ctx.strokeStyle=this.strokeStyle;this.ctx.lineWidth=this.lineWidth;var a=this.convertPointToView(this.origin,this.rootview);this.ctx.beginPath();this.ctx.strokeRect(a.x,a.y,this.bounds.width,this.bounds.height);this.ctx.fillRect(a.x,a.y,this.bounds.width,this.bounds.height);this.ctx.closePath();this._drawSubviews()},pointInView:function(a){if(this._pointInViewWidth(a)&&this._pointInViewHeight(a)){return true}},_pointInViewWidth:function(a){return a.x>=this.convertPointToWindow(this.origin).x&&a.x<=this.convertPointToWindow(this.origin).x+this.bounds.width},_pointInViewHeight:function(a){return a.y>=this.convertPointToWindow(this.origin).y&&a.y<=this.convertPointToWindow(this.origin).y+this.bounds.height}});var CircleView=View.extend({init:function(b,c,a){this._super(b,c);this.bounds={width:a*2,height:a*2};this.radius=a;this.strokeStyle="#F00";this.lineWidth=5;this.fillStyle="#000"},draw:function(){this.ctx.fillStyle=this.fillStyle;this.ctx.strokeStyle=this.strokeStyle;this.ctx.lineWidth=this.lineWidth;var a=this.convertPointToView(this.origin,this.rootview);this.ctx.beginPath();this.ctx.arc(a.x,a.y,this.radius,0,360,false);this.ctx.stroke();this.ctx.fill();this.ctx.closePath();this._drawSubviews()},pointInView:function(a){if(Math.pow(a.x-this.convertPointToWindow(this.origin).x,2)+Math.pow(a.y-this.convertPointToWindow(this.origin).y,2)<=Math.pow(this.radius,2)){return true}}});var ImageView=RectView.extend({init:function(d,b,e,c,a){this._super(b,e,c,a);this.src=d;this.image=new Image()},draw:function(){if(this.image.src!=this.src){this.image.src=this.src;this.src=this.image.src;this.image.onload=(function(a){return function(){a.draw()}})(this)}else{this.drawImage()}this._drawSubviews()},drawImage:function(){var a=this.convertPointToView(this.origin,this.rootview);this.ctx.drawImage(this.image,a.x,a.y,this.bounds.width,this.bounds.height)}});